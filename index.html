<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Web Chat + Game B·∫£o V·ªá C√¥ G√°i</title>
<style>
html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;font-family:Arial,sans-serif;}
.chat-box{position:fixed;top:10px;left:10px;width:320px;max-height:90%;background:white;padding:20px;border-radius:12px;box-shadow:0 0 10px rgba(0,0,0,0.3);display:flex;flex-direction:column;z-index:1000;}
#messages{flex:1;overflow-y:auto;border:1px solid #ddd;padding:10px;border-radius:8px;margin-bottom:10px;background:#fafafa;}
.msg{padding:6px;margin:5px 0;border-radius:6px;word-wrap:break-word;}
input{width:75%;padding:8px;margin-right:5px;}
button{width:20%;padding:9px;background:#007bff;color:white;border:none;border-radius:6px;cursor:pointer;}
button:hover{background:#0056c1;}
#game-container{position:fixed;top:0;left:0;width:100%;height:100%;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:999;background:black;}
#start-screen{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(255,255,255,0.8);padding:20px;border-radius:12px;text-align:center;z-index:1000;}
#start-screen button{padding:10px 20px;font-size:18px;border:none;border-radius:10px;cursor:pointer;margin-top:10px;}
#jump-btn {
    position: fixed;
    bottom: 15%;
    left: 50%;
    transform: translateX(-50%);
    padding: 20px 40px;
    font-size: 24px;
    border: none;
    border-radius: 15px;
    background: #f1c40f;
    color: black;
    font-weight: bold;
    cursor: pointer;
    z-index: 1000;
    display: none;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    transition: transform 0.1s ease;
}
#jump-btn:active {
    transform: translateX(-50%) scale(0.95);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
#game-over{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.8);padding:30px;border-radius:12px;text-align:center;color:white;z-index:1001;}
#game-over button{padding:20px 40px;font-size:22px;border:none;border-radius:12px;background:#f1c40f;cursor:pointer;margin-top:20px;}
canvas{display:block;}
</style>
</head>
<body>

<div class="chat-box" id="chat-box">
<h3>L√¥! ƒê√¢y l√† ƒë·ªãa b√†n c·ªßa anh Kh√¥i top1 sever tr√°i ƒë·∫•t</h3>
<div id="messages"></div>
<div style="display:flex;">
<input type="text" id="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn...">
<button id="send-btn">G·ª≠i</button>
</div>
</div>

<div id="game-container">
<div id="start-screen">
<h2>B·∫¢O V·ªÜ C√î G√ÅI KH·ªéI NH·ªÆNG CHI·∫æC GAI BI·∫æN TH√ÅI</h2>
<p>Nh·∫•n Start ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
<button id="start-btn">Start</button>
</div>
<canvas id="game"></canvas>
<button id="jump-btn">Bay</button>
<div id="game-over">
<h1>Game Over!</h1>
<p id="final-score"></p>
<p id="best-score"></p>
<button id="restart-btn">L√†m l·∫°i cu·ªôc ƒë·ªùi</button>
</div>
</div>

<audio id="flap-sound" src="flap.mp3"></audio>
<audio id="hit-sound" src="hit.mp3"></audio>
<audio id="point-sound" src="point.mp3"></audio>

<script>
// ===== Chat + m·∫≠t kh·∫©u =====
const GAME_PASSWORD="ƒë√£ ƒë∆∞·ª£c anh kh√¥i cho ph√©p";
function addMessage(text,sender="user"){
    const msg=document.createElement("div");
    msg.className="msg";
    msg.style.background=sender==="ƒë·ªá anh Kh√¥i"?"#d1e7dd":"#f8d7da";
    msg.innerText=(sender? sender+": ":"") + text;
    document.getElementById("messages").appendChild(msg);
    document.getElementById("messages").scrollTop=document.getElementById("messages").scrollHeight;
}
function botReply(text){
    text=text.trim().toLowerCase();
    let reply="IM M·ªíM NGAY !";
    if(text.includes("hi")||text.includes("hey")) reply="sao? üëã";
    else if(text.includes("th√≠ch g√¨")) reply="ƒë·∫øck quan t√¢m";
    else if(text.includes("game")) reply="H·ªéI ANH KH√îI DZ!";
    addMessage(reply,"ƒë·ªá anh Kh√¥i");
}
document.getElementById("send-btn").addEventListener("click",()=>{
    const input=document.getElementById("chat-input");
    const text=input.value;
    if(text.trim()==="") return;
    addMessage(text,"B·∫°n");
    input.value="";
    botReply(text);
    if(text.trim().toLowerCase()===GAME_PASSWORD.toLowerCase()){
        document.getElementById("chat-box").style.display="none";
        openGame();
    }
});
document.getElementById("chat-input").addEventListener("keydown",e=>{if(e.key==="Enter") document.getElementById("send-btn").click();});

// ===== Game =====
let canvas=document.getElementById("game"), ctx;
let bird, pipes, score, running, anim, shieldActive=false, shieldTimer=0, speed=3;
let lastTime=0, lastPipeTime=0, shieldIcon=null;
const names=["H√πng","Ho√†ng","Vi·ªát","Ti·∫øn","T√≠n","Khoa","S√°ng","H·∫≠u","Duy","Ph√∫c","ƒêi·ªÅn","Trung","Huy","Th·∫Øng","Quy·ªÅn","Nguy√™n"];
const rainbowColors=["red","orange","yellow","green","blue","indigo","violet"];
let nameIndex=0,colorIndex=0;
let bestScore=parseInt(localStorage.getItem("bestScore")||0);

let bg=new Image(); bg.src="bg.jpg";
let girlImg=new Image(); girlImg.src="girl.png";

function resizeCanvas(){ canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
window.addEventListener("resize",resizeCanvas); resizeCanvas();

function openGame(){
    document.getElementById("game-container").style.display="flex";
    document.getElementById("start-screen").style.display="flex";
    ctx=canvas.getContext("2d");
}

// Start button (keeps chat/password separate)
document.getElementById("start-btn").addEventListener("click",()=>{
    startGame();
});

function startGame(){
    const startScreen=document.getElementById("start-screen");
    startScreen.innerHTML="<h2>Chu·∫©n b·ªã...</h2><p id='countdown'>3</p>";
    let count=3;
    const countdownElem=document.getElementById("countdown");
    const interval=setInterval(()=>{
        count--;
        if(count>0) countdownElem.innerText=count;
        else{
            clearInterval(interval);
            startScreen.style.display="none";
            document.getElementById("jump-btn").style.display="block";
            initGame();
        }
    },1000);
}

function safePlayAudio(el){
    try{ if(el && typeof el.play==="function"){ el.currentTime=0; el.play().catch(()=>{}); } } catch(e){}
}

function initGame(){
    ctx=canvas.getContext("2d");
    bird={x:canvas.width/4, y:canvas.height/2, vy:0, radius:16};
    pipes=[]; score=0; running=true; lastTime=performance.now(); lastPipeTime=lastTime;
    nameIndex=0; colorIndex=0; shieldActive=false; shieldTimer=0; speed=3; shieldIcon=null;

    // controls
    window.onkeydown = e => { if(e.code==="Space" || e.key===" "){ bird.vy = -7; safePlayAudio(document.getElementById("flap-sound")); } }
    const jumpBtn = document.getElementById("jump-btn");
    jumpBtn.style.display="block";
    jumpBtn.onclick = () => { if(running){ bird.vy = -7; safePlayAudio(document.getElementById("flap-sound")); } }
    jumpBtn.addEventListener("touchstart", (e)=>{ e.preventDefault(); if(running){ bird.vy = -7; safePlayAudio(document.getElementById("flap-sound")); } });

    anim = requestAnimationFrame(loop);
}

function gameOver(){
    running=false;
    cancelAnimationFrame(anim);
    document.getElementById("jump-btn").style.display="none";
    safePlayAudio(document.getElementById("hit-sound"));
    const over=document.getElementById("game-over");
    over.style.display="flex";
    document.getElementById("final-score").innerText="ƒêi·ªÉm c·ªßa b·∫°n: "+score;
    if(score>bestScore){ bestScore=score; localStorage.setItem("bestScore",bestScore); }
    document.getElementById("best-score").innerText="ƒêi·ªÉm cao nh·∫•t: "+bestScore;
}

document.getElementById("restart-btn").addEventListener("click",()=>{
    document.getElementById("game-over").style.display="none";
    startGame();
});

function drawBackground(){ if(bg.complete) ctx.drawImage(bg,0,0,canvas.width,canvas.height); else { ctx.fillStyle="#87CEEB"; ctx.fillRect(0,0,canvas.width,canvas.height); } }

function drawPipe(p){
    const w = p.width;
    const topH = p.top;
    const gap = p.gap;
    // draw top spike (triangle)
    ctx.fillStyle = p.color;
    ctx.beginPath();
    ctx.moveTo(p.x,0);
    ctx.lineTo(p.x + w/2, topH);
    ctx.lineTo(p.x + w, 0);
    ctx.closePath();
    ctx.fill();
    // draw bottom spike
    ctx.beginPath();
    ctx.moveTo(p.x, canvas.height);
    ctx.lineTo(p.x + w/2, canvas.height - (topH + gap));
    ctx.lineTo(p.x + w, canvas.height);
    ctx.closePath();
    ctx.fill();
    // name near pipe
    ctx.fillStyle = "white"; ctx.font="16px Arial";
    const nm = p.name;
    ctx.fillText(nm, p.x + 4, Math.min(canvas.height-10, topH + gap + 18)); // place near bottom spike
}

function spawnShield(){
    // spawn somewhere mid-screen horizontally, random vertical position
    const x = Math.random() * (canvas.width - 200) + 100;
    const y = Math.random() * (canvas.height * 0.6) + canvas.height*0.15;
    shieldIcon = {x:x, y:y, size:36, createdAt:performance.now()};
}

function loop(t){
    if(!running) return;
    const dt = t - lastTime;
    lastTime = t;

    // spawn pipes periodically
    if(t - lastPipeTime > 1500){
        lastPipeTime = t;
        const gap = 150; // gap size
        const minTop = 60;
        const maxTop = canvas.height - gap - 120;
        const top = Math.floor(Math.random() * (maxTop - minTop) + minTop);
        const w = 70;
        pipes.push({x:canvas.width, top:top, gap:gap, width:w, name:names[nameIndex], color:rainbowColors[colorIndex], passed:false});
        nameIndex = (nameIndex+1) % names.length;
        colorIndex = (colorIndex+1) % rainbowColors.length;
    }

    // occasionally spawn shield if none
    if(!shieldIcon && Math.random() < 0.003) spawnShield();

    // physics
    bird.vy += 0.35 * (dt/16.67); // scale gravity by dt
    bird.y += bird.vy * (dt/16.67);

    // clamp bird inside screen
    if(bird.y > canvas.height - bird.radius){ bird.y = canvas.height - bird.radius; bird.vy = 0; }
    if(bird.y < bird.radius){ bird.y = bird.radius; bird.vy = 0; }

    // move pipes
    for(let p of pipes) p.x -= speed * (dt/16.67);
    // remove offscreen
    pipes = pipes.filter(p => p.x + p.width > -50);

    // draw
    drawBackground();

    // draw girl/bird
    if(girlImg.complete){
        ctx.drawImage(girlImg, bird.x - bird.radius, bird.y - bird.radius, bird.radius*2, bird.radius*2);
    } else {
        ctx.fillStyle="pink";
        ctx.beginPath(); ctx.arc(bird.x, bird.y, bird.radius, 0, Math.PI*2); ctx.fill();
    }

    // draw and collision check pipes
    for(let p of pipes){
        drawPipe(p);

        const inX = bird.x + bird.radius > p.x && bird.x - bird.radius < p.x + p.width;
        if(inX){
            // if bird is not within the safe gap then collision
            if(!(bird.y > p.top && bird.y < p.top + p.gap)){
                if(!shieldActive){
                    gameOver();
                    return;
                } else {
                    // if shield active, ignore collision but maybe break shield
                    shieldActive = false;
                    shieldTimer = 0;
                }
            }
        }

        if(!p.passed && (p.x + p.width) < bird.x - bird.radius){
            p.passed = true;
            score++;
            safePlayAudio(document.getElementById("point-sound"));
            // gradually increase difficulty
            if(score % 5 === 0) speed += 0.5;
        }
    }

    // draw shield icon if exists
    if(shieldIcon){
        // simple emoji draw
        ctx.font = "28px Arial";
        ctx.fillText("üõ°Ô∏è", shieldIcon.x, shieldIcon.y);
        ctx.fillStyle="white"; ctx.font="14px Arial";
        ctx.fillText("Kh√¥i DZ", shieldIcon.x - 20, shieldIcon.y + 26);

        // collect?
        const dx = Math.abs(bird.x - shieldIcon.x);
        const dy = Math.abs(bird.y - shieldIcon.y);
        if(dx < bird.radius + shieldIcon.size && dy < bird.radius + shieldIcon.size){
            shieldActive = true;
            shieldTimer = 7000; // ms
            shieldIcon = null;
            safePlayAudio(document.getElementById("point-sound"));
        } else {
            // optionally remove shield after 12s if not collected
            if(performance.now() - shieldIcon.createdAt > 12000) shieldIcon = null;
        }
    }

    // draw shield timer
    if(shieldActive){
        ctx.fillStyle="white"; ctx.font="18px Arial";
        ctx.fillText("Shield: "+Math.ceil(shieldTimer/1000)+"s", 10, 30);
        shieldTimer -= dt;
        if(shieldTimer <= 0) shieldActive = false;
    }

    // draw score
    ctx.fillStyle="black"; ctx.font="20px Arial";
    ctx.fillText("Score: "+score, canvas.width - 140, 30);

    anim = requestAnimationFrame(loop);
}
</script>
</body>
    </html>
    
