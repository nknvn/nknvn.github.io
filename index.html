<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Web Chat + Game B·∫£o V·ªá C√¥ G√°i</title>
<style>
html, body {
    margin:0;
    padding:0;
    height:100%;
    width:100%;
    overflow:hidden;
    font-family: Arial, sans-serif;
}
.chat-box {
    position: fixed;
    top: 10px;
    left: 10px;
    width: 320px;
    max-height: 90%;
    background:white;
    padding:20px;
    border-radius:12px;
    box-shadow:0 0 10px rgba(0,0,0,0.3);
    display:flex;
    flex-direction:column;
    z-index:1000;
}
#messages {
    flex:1;
    overflow-y:auto;
    border:1px solid #ddd;
    padding:10px;
    border-radius:8px;
    margin-bottom:10px;
    background:#fafafa;
}
.msg {padding:6px; margin:5px 0; border-radius:6px; word-wrap: break-word;}
input {width:75%; padding:8px; margin-right:5px;}
button {width:20%; padding:9px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer;}
button:hover {background:#0056c1;}

/* Game container */
#game-container {
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    display:none;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    z-index:999;
}
#start-screen {
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    background:rgba(255,255,255,0.8);
    padding:20px;
    border-radius:12px;
    text-align:center;
    z-index:1000;
}
#start-screen button, #game-over button {
    padding:10px 20px;
    font-size:18px;
    border:none;
    border-radius:10px;
    cursor:pointer;
    margin-top:10px;
}
#jump-btn {
    position:absolute;
    bottom:20px;
    left:50%;
    transform:translateX(-50%);
    padding:15px 25px;
    font-size:18px;
    border:none;
    border-radius:10px;
    background:#f1c40f;
    cursor:pointer;
    z-index:1000;
    display:none;
}
canvas {display:block;}
#game-over {
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    display:none;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    background:rgba(255,255,255,0.9);
    padding:20px;
    border-radius:12px;
    text-align:center;
    z-index:1001;
}
</style>
</head>
<body>

<div class="chat-box">
    <h3>L√¥! ƒê√¢y l√† ƒë·ªãa b√†n c·ªßa anh Kh√¥i top1 sever tr√°i ƒë·∫•t</h3>
    <div id="messages"></div>
    <div style="display:flex;">
        <input type="text" id="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn...">
        <button id="send-btn">G·ª≠i</button>
    </div>
</div>

<div id="game-container">
    <div id="start-screen">
        <h2>B·∫¢O V·ªÜ C√î G√ÅI KH·ªéI NH·ªÆNG CHI·∫æC GAI BI·∫æN TH√ÅI</h2>
        <p>Nh·∫•n Start ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
        <button onclick="startGame()">Start</button>
    </div>
    <canvas id="game"></canvas>
</div>

<div id="game-over">
    <h2>Game Over!</h2>
    <p id="final-score"></p>
    <p id="best-score"></p>
    <button onclick="restartGame()">L√†m l·∫°i cu·ªôc ƒë·ªùi</button>
</div>

<button id="jump-btn">Bay</button>

<script>
// ================= Chat ===================
function addMessage(text, sender="user"){
    const msgDiv = document.createElement("div");
    msgDiv.className = "msg";
    msgDiv.style.background = sender==="user" ? "#d1e7dd" : "#f8d7da";
    msgDiv.innerText = text;
    document.getElementById("messages").appendChild(msgDiv);
    document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
}

function botReply(text){
    text = text.trim().toLowerCase();
    let reply = "M√¨nh ch∆∞a hi·ªÉu b·∫°n n√≥i g√¨ üòÖ";
    if(text.includes("xin ch√†o") || text.includes("hello")){
        reply = "Ch√†o b·∫°n! üëã";
    } else if(text.includes("t√™n b·∫°n")){
        reply = "M√¨nh l√† Kh√¥i Bot üòé";
    } else if(text.includes("game")){
        reply = "Nh·∫≠p m·∫≠t kh·∫©u 'ƒë√£ ƒë∆∞·ª£c anh kh√¥i cho ph√©p' l√† m·ªü ƒë∆∞·ª£c game nha!";
    } else if(text.includes("bye") || text.includes("t·∫°m bi·ªát")){
        reply = "T·∫°m bi·ªát! H·∫πn g·∫∑p l·∫°i! üëã";
    }
    addMessage(reply, "bot");
}

document.getElementById("send-btn").addEventListener("click", ()=>{
    const input = document.getElementById("chat-input");
    const text = input.value;
    if(text.trim()==="") return;
    addMessage(text, "user");
    input.value="";
    botReply(text);
    // M·ªü game n·∫øu nh·∫≠p ƒë√∫ng m·∫≠t kh·∫©u
    const GAME_PASSWORD = "ƒë√£ ƒë∆∞·ª£c anh kh√¥i cho ph√©p";
    if(text.trim().toLowerCase() === GAME_PASSWORD){
        openGame();
    }
});

document.getElementById("chat-input").addEventListener("keydown", (e)=>{
    if(e.key === "Enter") document.getElementById("send-btn").click();
});

// ================= Game ===================
let canvas=document.getElementById("game");
let ctx;
let bird, pipes, score, running, anim, shieldActive=false, shieldTimer=0;
let lastPipe=0, last=0;
let speed = 3;
const names=["H√πng","Ho√†ng","Vi·ªát","Ti·∫øn","T√≠n","Khoa","S√°ng","H·∫≠u","Duy","Ph√∫c","ƒêi·ªÅn","Trung","Huy","Th·∫Øng","Quy·ªÅn","Nguy√™n"];
const rainbowColors=["red","orange","yellow","green","blue","indigo","violet"];
let nameIndex=0;
let colorIndex=0;
let shieldIcon=null;

// L∆∞u ƒëi·ªÉm cao nh·∫•t
let bestScore = parseInt(localStorage.getItem('bestScore') || 0);

// Resize canvas
function resizeCanvas(){
    if(window.innerWidth>window.innerHeight){
        canvas.width=window.innerWidth;
        canvas.height=window.innerHeight;
    } else {
        canvas.width=window.innerWidth;
        canvas.height=window.innerHeight*0.8;
    }
}
window.addEventListener("resize",resizeCanvas);
resizeCanvas();

function openGame(){
    document.getElementById("game-container").style.display="flex";
    document.getElementById("start-screen").style.display="flex";
    ctx=canvas.getContext("2d");
}

function startGame(){
    speed = 3; // reset t·ªëc ƒë·ªô
    const startScreen=document.getElementById("start-screen");
    startScreen.innerHTML="<h2>Chu·∫©n b·ªã...</h2><p id='countdown'>3</p>";
    let count=3;
    const countdownElem=document.getElementById("countdown");
    const interval=setInterval(()=>{
        count--;
        if(count>0){
            countdownElem.innerText=count;
        } else {
            clearInterval(interval);
            startScreen.style.display="none";
            document.getElementById("jump-btn").style.display="block";
            initGame();
        }
    },1000);
}

function initGame(){
    ctx=canvas.getContext("2d");
    bird={x:canvas.width/4, y:canvas.height/2, vy:0};
    pipes=[];
    score=0;
    running=true;
    last=performance.now();
    lastPipe=last;
    nameIndex=0;
    colorIndex=0;
    shieldActive=false;
    shieldTimer=0;
    shieldIcon=null;

    window.onkeydown=e=>{if(e.code==="Space") bird.vy=-7;}
    document.getElementById("jump-btn").addEventListener("click",()=>{if(running) bird.vy=-7;});

    anim=requestAnimationFrame(loop);
}

function closeGame(){
    running=false;
    cancelAnimationFrame(anim);
    document.getElementById("game-container").style.display="none";
    document.getElementById("jump-btn").style.display="none";
    showGameOver();
}

// Game over m√†n h√¨nh
function showGameOver(){
    document.getElementById("game-over").style.display="flex";
    document.getElementById("final-score").innerText = "ƒêi·ªÉm c·ªßa b·∫°n: "+score;
    if(score>bestScore){
        bestScore = score;
        localStorage.setItem('bestScore', bestScore);
    }
    document.getElementById("best-score").innerText = "ƒêi·ªÉm cao nh·∫•t: "+bestScore;
}

function restartGame(){
    document.getElementById("game-over").style.display="none";
    startGame();
}

// Draw background
function drawBackground(){
    const gradient=ctx.createLinearGradient(0,0,0,canvas.height);
    gradient.addColorStop(0,"#a8edea");
    gradient.addColorStop(1,"#fed6e3");
    ctx.fillStyle=gradient;
    ctx.fillRect(0,0,canvas.width,canvas.height);
}

// Draw spikes
function drawSpike(x, height, name, color){
    const spikeWidth=40;
    const spikeHeight=height;
    ctx.fillStyle=color;
    ctx.beginPath();
    ctx.moveTo(x,canvas.height);
    ctx.lineTo(x+spikeWidth/2,canvas.height-spikeHeight);
    ctx.lineTo(x+spikeWidth,canvas.height);
    ctx.closePath();
    ctx.fill();
    ctx.fillStyle="white";
    ctx.font="16px Arial";
    ctx.fillText(name,x,canvas.height-spikeHeight-5);
}

function loop(t){
    if(!running) return;
    const dt=t-last;
    last=t;
    drawBackground();

    // bird physics
    bird.vy+=0.35;
    bird.y+=bird.vy;
    if(bird.y>canvas.height-20) {bird.y=canvas.height-20; bird.vy=0;}
    if(bird.y<20) {bird.y=20; bird.vy=0;}

    // spawn spikes
    if(t-lastPipe>1500){
        lastPipe=t;
        let name=names[nameIndex];
        let color=rainbowColors[colorIndex];
        pipes.push({x:canvas.width, name:name, color:color});
        nameIndex=(nameIndex+1)%names.length;
        colorIndex=(colorIndex+1)%rainbowColors.length;
    }

    // move spikes
    pipes.forEach(p=>p.x-=speed);
    pipes=pipes.filter(p=>p.x>-50);

    // draw spikes + collision
    pipes.forEach(p=>{
        drawSpike(p.x,150,p.name,p.color);
        if(bird.x+15>p.x && bird.x-15<p.x+40){
            if(bird.y>canvas.height-150){
                if(!shieldActive){
                    closeGame();
                    return;
                }
            }
        }
        if(!p.passed && p.x+40<bird.x){p.passed=true; score++;}
    });

    // draw bird
    ctx.font="32px Arial";
    ctx.fillText("üëß",bird.x-16,bird.y+16);

    // shield
    if(shieldIcon){
        ctx.font="32px Arial";
        ctx.fillText("üï¥Ô∏è",shieldIcon.x,shieldIcon.y);
        ctx.font="16px Arial";
        ctx.fillText("Kh√¥i DZ",shieldIcon.x-10,shieldIcon.y+30);
        if(bird.x>shieldIcon.x-10 && bird.x<shieldIcon.x+30 && bird.y>shieldIcon.y-10 && bird.y<shieldIcon.y+30){
            shieldActive=true;
            shieldTimer=7000;
            shieldIcon=null;
            speed += 1; // tƒÉng t·ªëc ƒë·ªô khi l·∫•y l√° ch·∫Øn
        }
    }

    // draw shield timer
    if(shieldActive){
        ctx.fillStyle="white";
        ctx.font="18px Arial";
        ctx.fillText("Shield: "+Math.ceil(shieldTimer/1000)+"s",10,30);
        shieldTimer-=dt;
        if(shieldTimer<=0){shieldActive=false; shieldTimer=0;}
    }

    // draw score
    ctx.fillStyle="black";
    ctx.font="20px Arial";
    ctx.fillText("Score: "+score,canvas.width-120,30);

    anim=requestAnimationFrame(loop);
}
</script>

</body>
</html>
