<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PARKOUR ULTIMATE SOUL — GOD MODE 7.0 FULL</title>
<style>
/* =====================
   RESET & GLOBAL
===================== */
html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family: 'Press Start 2P', monospace;
    background: #000;
    touch-action: none;
}
canvas { display: block; background: #000; }

/* =====================
   UI LAYER
===================== */
#uiLayer {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none; z-index: 100;
}

/* Buttons */
button {
    font-family: 'Arial', sans-serif;
    cursor: pointer;
}
button.uiButton {
    margin: 10px; padding: 15px 30px;
    background: #0ff; color: #000;
    border: none; border-radius: 10px;
    font-size: 1em; transition: 0.2s;
}
button.uiButton:hover { background: #0aa; color: #fff; }

/* =====================
   SCREENS
===================== */
#menuScreen, #deathScreen, #shopScreen, #optionsScreen, #leaderboardScreen, #creditsScreen, #bossIntro {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    display: flex; justify-content: center; align-items: center;
    flex-direction: column;
    background: rgba(0,0,0,0.85);
    color: #0ff;
    font-size: 2em;
    z-index: 100;
    transition: opacity 0.5s;
    opacity: 1;
}
#menuScreen.hide, #deathScreen.hide, #shopScreen.hide, #optionsScreen.hide, #leaderboardScreen.hide, #creditsScreen.hide, #bossIntro.hide {
    opacity: 0; pointer-events: none;
}

/* =====================
   MOBILE CONTROLS
===================== */
#mobileControls {
    position: fixed; bottom: 20px; width: 100%;
    display: flex; justify-content: space-around;
    z-index: 99;
}
.mobileBtn {
    width: 80px; height: 80px;
    border-radius: 50%;
    background: rgba(0,255,255,0.3);
    border: 2px solid #0ff;
    touch-action: none;
}
.mobileBtn:active { background: rgba(0,255,255,0.7); }

/* =====================
   BIOME OVERLAY
===================== */
#biomeOverlay {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    mix-blend-mode: overlay;
    pointer-events: none;
}

/* Particle system */
.particle {
    position: absolute;
    pointer-events: none;
    width: 5px; height: 5px;
    border-radius: 50%;
    background: #fff;
}

/* Font import */
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
body { font-family: 'Press Start 2P', monospace; }
audio { display: none; }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>

<div id="uiLayer">
    <!-- MENU -->
    <div id="menuScreen">
        <div>PARKOUR ULTIMATE SOUL<br>GOD MODE 7.0 FULL</div>
        <button class="uiButton" onclick="startGame()">START</button>
        <button class="uiButton" onclick="showOptions()">OPTIONS</button>
        <button class="uiButton" onclick="showShop()">SHOP</button>
        <button class="uiButton" onclick="showLeaderboard()">LEADERBOARD</button>
        <button class="uiButton" onclick="showCredits()">CREDITS</button>
    </div>

    <!-- DEATH -->
    <div id="deathScreen" class="hide">
        <div>YOU DIED</div>
        <button class="uiButton" onclick="restartGame()">RETRY</button>
        <button class="uiButton" onclick="showMenu()">MENU</button>
    </div>

    <!-- SHOP -->
    <div id="shopScreen" class="hide">
        <div>SHOP</div>
        <button class="uiButton" onclick="buyUpgrade('speed')">SPEED (10 coins)</button>
        <button class="uiButton" onclick="buyUpgrade('jump')">JUMP (10 coins)</button>
        <button class="uiButton" onclick="buyUpgrade('dash')">DASH (10 coins)</button>
        <button class="uiButton" onclick="buyUpgrade('shield')">SHIELD (10 coins)</button>
        <button class="uiButton" onclick="buyUpgrade('revive')">REVIVE (10 coins)</button>
        <button class="uiButton" onclick="buyUpgrade('skin')">SKIN (10 coins)</button>
        <button class="uiButton" onclick="closeShop()">BACK</button>
    </div>

    <!-- OPTIONS -->
    <div id="optionsScreen" class="hide">
        <div>OPTIONS</div>
        <button class="uiButton" onclick="toggleAudio()">TOGGLE MUSIC</button>
        <button class="uiButton" onclick="closeOptions()">BACK</button>
    </div>

    <!-- LEADERBOARD -->
    <div id="leaderboardScreen" class="hide">
        <div>LEADERBOARD</div>
        <div id="leaderboardList">No records yet</div>
        <button class="uiButton" onclick="closeLeaderboard()">BACK</button>
    </div>

    <!-- CREDITS -->
    <div id="creditsScreen" class="hide">
        <div>CREDITS</div>
        <div>Created by Ngọc Khôi Nguyễn</div>
        <button class="uiButton" onclick="closeCredits()">BACK</button>
    </div>

    <!-- BOSS INTRO -->
    <div id="bossIntro" class="hide">
        <div id="bossName">BOSS</div>
    </div>

    <!-- MOBILE CONTROLS -->
    <div id="mobileControls">
        <div class="mobileBtn" id="leftBtn">◀</div>
        <div class="mobileBtn" id="jumpBtn">▲</div>
        <div class="mobileBtn" id="dashBtn">▶</div>
    </div>

    <!-- BIOME OVERLAY -->
    <div id="biomeOverlay"></div>
</div>

<!-- AUDIO -->
<audio id="bgMusic" loop src="bgm.mp3"></audio>
<audio id="jumpSnd" src="jump.wav"></audio>
<audio id="dashSnd" src="dash.wav"></audio>
<audio id="hitSnd" src="hit.wav"></audio>
<audio id="bossSnd" src="boss.wav"></audio>
<audio id="coinSnd" src="coin.wav"></audio>

<script>
// =====================
// GLOBAL VARIABLES
// =====================
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let width = canvas.width = window.innerWidth;
let height = canvas.height = window.innerHeight;

let gameState = 'menu';
let keys = {};
let player = {};
let platforms = [];
let enemies = [];
let particles = [];
let biomes = [];
let currentBiome = 0;
let camera = {x:0, y:0};
let upgrades = {speed:0, jump:0, dash:0, shield:false, revive:0, skin:0};
let coins = 0;
let audio = {
    bg: document.getElementById('bgMusic'),
    jump: document.getElementById('jumpSnd'),
    dash: document.getElementById('dashSnd'),
    hit: document.getElementById('hitSnd'),
    boss: document.getElementById('bossSnd'),
    coin: document.getElementById('coinSnd')
};
let lastTime = 0;
let bosses = [];
let boss = null;

// =====================
// EVENT LISTENERS
// =====================
window.addEventListener('keydown', e=>keys[e.code]=true);
window.addEventListener('keyup', e=>keys[e.code]=false);
window.addEventListener('resize', ()=>{
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
});

// =====================
// PLAYER INIT
// =====================
function initPlayer(){
    player = {
        x: width/2, y: height-150,
        w: 50, h: 80,
        vx:0, vy:0,
        speed:5+upgrades.speed,
        jump:15+upgrades.jump,
        dash:20+upgrades.dash,
        onGround:false,
        shield: upgrades.shield,
        dashCooldown:0,
        doubleJump:true,
        health:100,
        maxHealth:100
    };
}

// =====================
// PLATFORM GENERATION
// =====================
function generatePlatforms(){
    platforms = [];
    let y = height - 50;
    for(let i=0;i<200;i++){
        let w = 100 + Math.random()*200;
        platforms.push({x:i*250 + Math.random()*100, y:y, w:w, h:20, type:'normal'});
        y -= Math.random()*100;
        if(y<100) y = height - 50;
    }
}

// =====================
// PLAYER INPUT
// =====================
function handleInput(){
    if(keys['ArrowLeft']) player.vx = -player.speed;
    else if(keys['ArrowRight']) player.vx = player.speed;
    else player.vx = 0;

    if(keys['Space']){
        if(player.onGround){player.vy=-player.jump;player.onGround=false;audio.jump.play();player.doubleJump=true;}
        else if(player.doubleJump){player.vy=-player.jump;player.doubleJump=false;audio.jump.play();}
    }

    if(keys['KeyX'] && player.dashCooldown<=0){
        player.vx += (keys['ArrowRight']?-1:1)*player.dash;
        player.dashCooldown=0.5;
        audio.dash.play();
    }
}

// =====================
// PLAYER PHYSICS
// =====================
function updatePlayer(dt){
    player.vy += 50*dt;
    player.x += player.vx;
    player.y += player.vy;
    if(player.dashCooldown>0) player.dashCooldown-=dt;
    player.onGround=false;

    for(let p of platforms){
        if(player.x+player.w>p.x && player.x<p.x+p.w &&
           player.y+player.h>p.y && player.y+player.h<p.y+p.h+20 &&
           player.vy>=0){
            player.y=p.y-player.h;
            player.vy=0;
            player.onGround=true;
        }
    }
    if(player.y>height+200) gameOver();
}

// =====================
// CAMERA
// =====================
function updateCamera(){ camera.x=player.x-width/2; camera.y=player.y-height/2; }

// =====================
// RENDER FUNCTIONS
// =====================
function renderPlatforms(){ ctx.fillStyle='gray'; for(let p of platforms) ctx.fillRect(p.x,p.y,p.w,p.h);}
function renderPlayer(){ ctx.fillStyle=player.shield?'cyan':'white'; ctx.fillRect(player.x,player.y,player.w,player.h); }

// =====================
// BIOMES
// =====================
function initBiomes(){
    biomes = [
        {name:'Neon City', color:'rgba(0,255,255,0.2)'},
        {name:'Lava Hell', color:'rgba(255,50,0,0.2)'},
        {name:'Cyber Desert', color:'rgba(255,255,0,0.2)'},
        {name:'Frozen Void', color:'rgba(0,255,255,0.2)'},
        {name:'Toxic Swamp', color:'rgba(0,150,0,0.2)'},
        {name:'Sky Temple', color:'rgba(255,255,255,0.2)'},
        {name:'Starfield', color:'rgba(200,200,255,0.2)'},
        {name:'Quantum Forest', color:'rgba(100,255,100,0.2)'},
        {name:'Infinity Ruins', color:'rgba(255,100,255,0.2)'},
        {name:'Rainbow Horizon', color:'rgba(255,0,255,0.2)'}
    ];
}

function checkBiome(){
    currentBiome=Math.floor(player.x/1000)%biomes.length;
    document.getElementById('biomeOverlay').style.background=biomes[currentBiome].color;
}

// =====================
// SHOP & UPGRADES
// =====================
function buyUpgrade(type){
    if(coins < 10) return; // Not enough coins
    coins -= 10;
    switch(type){
        case 'speed': upgrades.speed+=1; player.speed=5+upgrades.speed; break;
        case 'jump': upgrades.jump+=1; player.jump=15+upgrades.jump; break;
        case 'dash': upgrades.dash+=5; break;
        case 'shield': upgrades.shield=true; player.shield=true; break;
        case 'revive': upgrades.revive+=1; break;
        case 'skin': upgrades.skin+=1; break;
    }
    audio.coin.play();
}

// =====================
// SHOW / HIDE SCREENS
// =====================
function showMenu(){
    document.getElementById('menuScreen').classList.remove('hide');
    document.getElementById('deathScreen').classList.add('hide');
    document.getElementById('shopScreen').classList.add('hide');
    document.getElementById('optionsScreen').classList.add('hide');
    document.getElementById('leaderboardScreen').classList.add('hide');
    document.getElementById('creditsScreen').classList.add('hide');
    document.getElementById('bossIntro').classList.add('hide');
    gameState='menu';
}
function showShop(){
    document.getElementById('shopScreen').classList.remove('hide');
    document.getElementById('menuScreen').classList.add('hide');
    gameState='shop';
}
function showDeath(){
    document.getElementById('deathScreen').classList.remove('hide');
    gameState='dead';
}
function showOptions(){
    document.getElementById('optionsScreen').classList.remove('hide');
    document.getElementById('menuScreen').classList.add('hide');
    gameState='options';
}
function closeOptions(){
    document.getElementById('optionsScreen').classList.add('hide');
    gameState='menu';
}
function showLeaderboard(){
    let scores = JSON.parse(localStorage.getItem('scores') || '[]');
    document.getElementById('leaderboardList').innerHTML = scores.length ? scores.map((s,i)=>`${i+1}. ${s}`).join('<br>') : 'No records yet';
    document.getElementById('leaderboardScreen').classList.remove('hide');
    document.getElementById('menuScreen').classList.add('hide');
    gameState='leaderboard';
}
function closeLeaderboard(){
    document.getElementById('leaderboardScreen').classList.add('hide');
    gameState='menu';
}
function showCredits(){
    document.getElementById('creditsScreen').classList.remove('hide');
    document.getElementById('menuScreen').classList.add('hide');
    gameState='credits';
}
function closeCredits(){
    document.getElementById('creditsScreen').classList.add('hide');
    gameState='menu';
}
function closeShop(){
    document.getElementById('shopScreen').classList.add('hide');
    gameState='playing';
}

// =====================
// START / RESTART
// =====================
function startGame(){ 
    document.getElementById('menuScreen').classList.add('hide'); 
    gameState='playing'; 
    initGame(); 
}
function restartGame(){ 
    initPlayer(); 
    player.x=width/2; 
    player.y=height-150; 
    gameState='playing'; 
    requestAnimationFrame(loop); 
}

// =====================
// MOBILE BUTTONS
// =====================
document.getElementById('leftBtn').addEventListener('touchstart',()=>keys['ArrowLeft']=true);
document.getElementById('leftBtn').addEventListener('touchend',()=>keys['ArrowLeft']=false);
document.getElementById('jumpBtn').addEventListener('touchstart',()=>keys['Space']=true);
document.getElementById('jumpBtn').addEventListener('touchend',()=>keys['Space']=
