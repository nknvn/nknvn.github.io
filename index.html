<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Game Parkour Cực Đỉnh – Ultimate Version 2.0 by ahkhoidz</title>
<style>
    html, body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #000;
        font-family: Arial, sans-serif;
        touch-action: none;
    }
    #gameCanvas {
        display: block;
        background: #000;
    }
    #uiLayer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        color: white;
        padding: 10px;
        z-index: 10;
        font-size: 20px;
        pointer-events: none;
        text-shadow: 0 0 10px #fff;
    }
    #menuStart {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: radial-gradient(#222, #000);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 20;
        color: white;
        text-align: center;
    }
    #menuStart h1 {
        font-size: 3rem;
        margin-bottom: 30px;
        text-shadow: 0 0 20px #00f, 0 0 40px #0ff;
    }
    #menuStart button {
        padding: 15px 40px;
        border: none;
        border-radius: 12px;
        font-size: 22px;
        cursor: pointer;
        background: #0ff;
        color: #000;
        font-weight: bold;
        box-shadow: 0 0 15px #0ff;
        transition: 0.2s;
    }
    #menuStart button:hover {
        transform: scale(1.1);
        box-shadow: 0 0 30px #0ff;
    }
</style>
</head>
<body>

<div id="uiLayer">Điểm: <span id="score">0</span> | Highscore: <span id="highscore">0</span></div>
<div id="menuStart">
    <h1>GAME PARKOUR CỰC ĐỈNH</h1>
    <button onclick="startGame()">BẮT cmn ĐẦU</button>
</div>
<canvas id="gameCanvas"></canvas>

<script>
// ---------------------------
// CANVAS & CONTROLS
// ---------------------------
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

let keys = {};
addEventListener("keydown", e => keys[e.key] = true);
addEventListener("keyup", e => keys[e.key] = false);

// ---------------------------
// GAME STATE
// ---------------------------
let score = 0;
let highscore = localStorage.getItem("parkourHighscore") || 0;
document.getElementById("highscore").innerText = highscore;
let gameRunning = false;

// ---------------------------
// PLAYER
// ---------------------------
let player = {
    x: 150,
    y: 0,
    size: 45,
    vx: 0,
    vy: 0,
    onGround: false,
    dashCooldown: 0,
    trail: []
};

// ---------------------------
// WORLD
// ---------------------------
let platforms = [];
let spikes = [];
let coins = [];
let biomeColors = ["#1e90ff", "#ff00ff", "#00ffff", "#ff5500"];

function generateWorld() {
    platforms = [];
    spikes = [];
    coins = [];
    let x = 0;
    for (let i = 0; i < 300; i++) {
        let y = 400 + Math.sin(i * 0.3) * 120;
        let w = 280;
        platforms.push({ x, y, w, biome: biomeColors[Math.floor(i / 80)] });

        if (Math.random() < 0.25)
            coins.push({ x: x + 120, y: y - 60, r: 20, rot: 0, collected: false });

        if (Math.random() < 0.15)
            spikes.push({ x: x + 100, y: y - 25 });

        x += 350;
    }
}
generateWorld();

// ---------------------------
// BOSS
// ---------------------------
let boss = {
    x: -300,
    y: 200,
    size: 110,
    speed: 1.7,
    vy: 0,
    jumpTimer: 0,
    bullets: []
};

// ---------------------------
// SOUNDS
// ---------------------------
const sounds = {};
function loadSound(name, url) {
    const audio = new Audio(url);
    audio.volume = 0.3;
    sounds[name] = audio;
}
loadSound("jump", "https://freesound.org/data/previews/331/331912_3248244-lq.mp3");
loadSound("dash", "https://freesound.org/data/previews/109/109662_945474-lq.mp3");
loadSound("coin", "https://freesound.org/data/previews/331/331912_3248244-lq.mp3");
loadSound("death", "https://freesound.org/data/previews/569/569880_11546212-lq.mp3");
loadSound("bossFire", "https://freesound.org/data/previews/331/331912_3248244-lq.mp3");

// ---------------------------
// GAME LOOP
// ---------------------------
function gameLoop() {
    if (!gameRunning) return;
    requestAnimationFrame(gameLoop);

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Physics
    player.vy += 0.6; 
    if (player.vy > 14) player.vy = 14;
    player.x += player.vx;
    player.y += player.vy;
    player.vx = 5;

    // Jump
    if ((keys[" "] || keys["ArrowUp"]) && player.onGround) {
        player.vy = -13;
        player.onGround = false;
        sounds.jump?.play();
    }

    // Dash
    if (keys["Shift"] && player.dashCooldown <= 0) {
        player.vx = 25;
        player.dashCooldown = 60;
        player.trail.push({ x: player.x, y: player.y, alpha: 1 });
        sounds.dash?.play();
    }
    if (player.dashCooldown > 0) player.dashCooldown--;

    // Trail update
    player.trail.forEach(t => t.alpha -= 0.05);
    player.trail = player.trail.filter(t => t.alpha > 0);

    // Platform collision
    player.onGround = false;
    for (let p of platforms) {
        if (player.x + player.size > p.x && player.x < p.x + p.w) {
            if (player.y + player.size > p.y && player.y + player.size < p.y + 25) {
                player.y = p.y - player.size;
                player.vy = 0;
                player.onGround = true;
            }
        }
    }

    // Coin collection
    coins.forEach(c => {
        if (!c.collected) {
            let dx = (player.x + player.size/2) - c.x;
            let dy = (player.y + player.size/2) - c.y;
            if (dx*dx + dy*dy < 900) {
                c.collected = true;
                score += 5;
                sounds.coin?.play();
            }
            c.rot += 0.15;
        }
    });

    // Spike collision
    for (let s of spikes) {
        if (player.x + player.size > s.x && player.x < s.x + 40) {
            if (player.y + player.size > s.y) die();
        }
    }

    // Boss AI
    boss.vy += 0.5;
    boss.y += boss.vy;
    if (boss.y > 400) { boss.y = 400; boss.vy = 0; }

    boss.jumpTimer++;
    if (boss.jumpTimer > 120) {
        boss.vy = -10;
        boss.jumpTimer = 0;
    }

    boss.x += boss.speed;
    if (boss.x < player.x - 600) boss.x = player.x - 600;

    // Boss bullets
    if (Math.random() < 0.03) {
        boss.bullets.push({ x: boss.x + 100, y: boss.y + 40 });
        sounds.bossFire?.play();
    }
    boss.bullets.forEach(b => b.x += 8);

    // Bullet collision
    boss.bullets.forEach(b => {
        if (player.x < b.x && player.x + player.size > b.x && player.y < b.y && player.y + player.size > b.y) die();
    });

    // Camera
    let camX = -player.x + canvas.width / 4;

    // DRAW
    ctx.save();
    ctx.translate(camX, 0);

    // Platform
    platforms.forEach(p => { ctx.fillStyle = p.biome; ctx.fillRect(p.x, p.y, p.w, 20); });

    // Coins
    coins.forEach(c => {
        if (!c.collected) {
            ctx.save();
            ctx.translate(c.x, c.y);
            ctx.rotate(c.rot);
            ctx.fillStyle = "#ff0";
            ctx.fillRect(-c.r/2, -c.r/2, c.r, c.r);
            ctx.restore();
        }
    });

    // Spikes
    ctx.fillStyle = "#f00";
    spikes.forEach(s => ctx.fillRect(s.x, s.y, 40, 40));

    // Player trail
    player.trail.forEach(t => {
        ctx.fillStyle = `rgba(0,255,255,${t.alpha})`;
        ctx.beginPath();
        ctx.arc(t.x, t.y, player.size, 0, Math.PI*2);
        ctx.fill();
    });

    // Player
    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.arc(player.x, player.y, player.size, 0, Math.PI*2);
    ctx.fill();

    // Boss
    ctx.fillStyle = "#ff00ff";
    ctx.beginPath();
    ctx.arc(boss.x, boss.y, boss.size, 0, Math.PI*2);
    ctx.fill();

    // Boss bullets
    ctx.fillStyle = "#0ff";
    boss.bullets.forEach(b => ctx.fillRect(b.x, b.y, 20, 6));

    ctx.restore();

    // UI
    document.getElementById("score").innerText = score;
    if(score > highscore) {
        highscore = score;
        document.getElementById("highscore").innerText = highscore;
        localStorage.setItem("parkourHighscore", highscore);
    }
}

// ---------------------------
// DEATH
// ---------------------------
function die() {
    sounds.death?.play();
    alert("DU ĐIE! Điểm: " + score);
    resetGame();
}

function resetGame() {
    player = { x: 150, y:0, size:45, vx:0, vy:0, onGround:false, dashCooldown:0, trail:[] };
    boss = { x:-300, y:200, size:110, speed:1.7, vy:0, jumpTimer:0, bullets:[] };
    score = 0;
    generateWorld();
    document.getElementById("menuStart").style.display = "flex";
    gameRunning = false;
}

// ---------------------------
// START GAME
// ---------------------------
function startGame() {
    document.getElementById("menuStart").style.display = "none";
    gameRunning = true;
    gameLoop();
}
</script>

</body>
</html>
